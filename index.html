a<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2641/2641271.png">
    
    <title>ScooterMaster V26 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { slate: { 850: '#151f32', 900: '#0f172a' }, accent: '#10b981', danger: '#ef4444', warning: '#f59e0b', info: '#3b82f6' }, fontFamily: { mono: ['ui-monospace', 'monospace'] } } } }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .digital-clock { text-shadow: 0 0 15px rgba(16, 185, 129, 0.4); letter-spacing: -1px; }
        .dashboard-value { text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #map { height: 100%; width: 100%; border-radius: 0; z-index: 1; }
        
        /* SPECIFIC STYLES */
        .wake-active { color: #fbbf24; text-shadow: 0 0 10px #fbbf24; }
        .nav-arrow { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #10b981; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); transition: transform 0.3s ease; }
        .nav-arrow-container { display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; background: rgba(15, 23, 42, 0.5); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        /* PIN CODE */
        #login-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: opacity 0.5s; }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #334155; transition: all 0.2s; }
        .pin-dot.filled { background: #10b981; border-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .numpad-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid #334155; color: white; font-size: 24px; display: flex; items-center; justify-content: center; transition: all 0.1s; background: rgba(30, 41, 59, 0.5); }
        .numpad-btn:active { background: #10b981; color: #0f172a; border-color: #10b981; transform: scale(0.95); }
        #login-error { transition: opacity 0.3s; opacity: 0; }

        /* HUD & TABS */
        .tab-content { display: none; flex-direction: column; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6rem; }
        .tab-content.active { display: flex; }
        .nav-btn.active { color: #10b981; background: rgba(16, 185, 129, 0.1); border-color: #10b981; }
        .hud-overlay { position: absolute; z-index: 500; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none; }
        .hud-top-left { top: 1rem; left: 1rem; }
        .hud-top-right { top: 1rem; right: 1rem; text-align: right; }
        .hud-bottom-center { bottom: 6rem; left: 50%; transform: translateX(-50%); width: 90%; pointer-events: auto; }
    </style>
</head>
<body onclick="requestWakeLock()"> 

    <div id="login-overlay">
        <div class="mb-8 flex flex-col items-center">
            <i class="fa-solid fa-crown text-4xl text-accent mb-4"></i>
            <h2 class="text-white font-bold text-xl uppercase tracking-widest">Ultimate V26</h2>
            <p class="text-slate-500 text-xs mt-1">Code PIN requis</p>
            <p id="login-error" class="text-red-500 text-xs font-bold mt-2">Code Incorrect</p>
        </div>
        <div class="flex gap-4 mb-8"><div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div></div>
        <div class="grid grid-cols-3 gap-6">
            <button class="numpad-btn" onclick="typePin(1)">1</button><button class="numpad-btn" onclick="typePin(2)">2</button><button class="numpad-btn" onclick="typePin(3)">3</button>
            <button class="numpad-btn" onclick="typePin(4)">4</button><button class="numpad-btn" onclick="typePin(5)">5</button><button class="numpad-btn" onclick="typePin(6)">6</button>
            <button class="numpad-btn" onclick="typePin(7)">7</button><button class="numpad-btn" onclick="typePin(8)">8</button><button class="numpad-btn" onclick="typePin(9)">9</button>
            <div class="w-[60px]"></div><button class="numpad-btn" onclick="typePin(0)">0</button><button class="numpad-btn text-red-400 border-red-900/50" onclick="clearPin()"><i class="fa-solid fa-delete-left"></i></button>
        </div>
    </div>

    <div id="app-modal" class="fixed inset-0 z-[1000] bg-slate-900/90 backdrop-blur-sm hidden flex-col items-center justify-center p-6">
        <div class="glass-panel w-full max-w-sm p-5 rounded-2xl border border-slate-600 shadow-2xl relative">
            <h3 class="text-white font-bold text-lg mb-4 text-center">Ajouter un raccourci</h3>
            <label class="block text-xs text-slate-400 mb-1">Type d'application</label>
            <select id="app-select" onchange="prefillApp()" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white mb-3 outline-none focus:border-accent">
                <option value="custom">-- Choisir ou Personnaliser --</option>
                <option value="spotify|spotify:|fa-brands fa-spotify|#1DB954">Spotify</option>
                <option value="deezer|deezer:|fa-brands fa-deezer|#a255ff">Deezer</option>
                <option value="youtube|https://music.youtube.com|fa-brands fa-youtube|#ff0000">YouTube Music</option>
                <option value="apple|music:|fa-solid fa-music|#fa2d48">Apple Music</option>
                <option value="waze|https://waze.com/ul|fa-brands fa-waze|#3b82f6">Waze</option>
                <option value="maps|https://maps.google.com|fa-solid fa-map-location-dot|#10b981">Google Maps</option>
                <option value="tel|tel:|fa-solid fa-phone|#ffffff">Téléphone</option>
            </select>
            <label class="block text-xs text-slate-400 mb-1">Nom (Optionnel)</label>
            <input type="text" id="app-name" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white mb-3 outline-none text-sm" placeholder="Ex: Spotify">
            <label class="block text-xs text-slate-400 mb-1">Lien / URI</label>
            <input type="text" id="app-url" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white mb-3 outline-none text-xs font-mono" placeholder="spotify:">
            <input type="hidden" id="app-icon" value="fa-solid fa-cube">
            <input type="hidden" id="app-color" value="#ffffff">
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="closeAppModal()" class="bg-slate-700 text-slate-300 py-3 rounded-xl font-bold">Annuler</button>
                <button onclick="saveShortcut()" class="bg-accent text-slate-900 py-3 rounded-xl font-bold">Sauver</button>
            </div>
            <button id="btn-delete-app" onclick="deleteCurrentShortcut()" class="w-full mt-3 py-2 text-red-400 text-xs border border-red-900/50 rounded hover:bg-red-900/20 hidden">Supprimer ce raccourci</button>
        </div>
    </div>

    <nav class="glass-panel sticky top-0 z-50 border-b border-slate-700/50 pt-safe-top h-16 flex-none flex justify-between items-center px-4">
        <div class="flex items-center gap-2 text-slate-500 z-10 w-20"><span class="text-[10px] font-bold uppercase tracking-wider">V26</span></div>
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center gap-3"><div class="text-3xl font-black text-white digital-clock font-mono" id="clock-display">--:--</div></div>
        <div class="flex items-center justify-end gap-3 z-10 w-auto">
            <div id="top-weather" class="flex items-center gap-2 text-xs font-bold text-slate-300"><span class="text-[9px] opacity-50">GPS?</span></div>
            <div class="h-4 w-[1px] bg-slate-700"></div>
            <i id="wake-icon" class="fa-solid fa-lightbulb text-slate-600 text-sm transition-colors duration-500"></i>
        </div>
    </nav>

    <main class="flex-grow relative w-full max-w-7xl mx-auto overflow-hidden">
        
        <div id="tab-dashboard" class="tab-content active p-3 gap-3">
            
            <div class="grid grid-cols-4 gap-2 flex-none h-18">
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center bg-slate-800/40">
                    <span class="text-[8px] text-slate-500 uppercase font-bold">Total</span>
                    <div class="font-mono font-bold text-white text-sm"><span id="disp-odo-total">0.0</span></div>
                    <span class="text-[7px] text-slate-500">km</span>
                </div>
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center relative">
                    <span class="text-[8px] text-accent uppercase font-bold">Trip A</span>
                    <div class="font-mono font-bold text-white text-sm"><span id="disp-trip-a">0.0</span></div>
                    <button onclick="resetTrip('A')" class="absolute top-1 right-1 text-[8px] text-slate-600 hover:text-red-400 p-1"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center relative">
                    <span class="text-[8px] text-warning uppercase font-bold">Trip B</span>
                    <div class="font-mono font-bold text-white text-sm"><span id="disp-trip-b">0.0</span></div>
                    <button onclick="resetTrip('B')" class="absolute top-1 right-1 text-[8px] text-slate-600 hover:text-red-400 p-1"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center bg-emerald-900/20 border border-emerald-500/30">
                    <i class="fa-solid fa-piggy-bank text-emerald-400 text-sm mb-1"></i>
                    <div class="text-[10px] font-bold text-white"><span id="savings-display">0</span> €</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 flex-none">
                <div class="glass-panel rounded-xl p-2 flex flex-col items-center justify-center bg-slate-800/60 border-l-2 border-l-accent"><span class="text-slate-500 text-[9px] font-bold uppercase">Vitesse</span><div class="flex items-baseline"><span id="dash-speed" class="text-3xl font-bold text-white dashboard-value font-mono leading-none">0</span><span class="text-[10px] text-accent ml-1">km/h</span></div></div>
                <div class="glass-panel rounded-xl p-2 flex flex-col items-center justify-center bg-slate-800/60 border-r-2 border-r-accent"><span class="text-slate-500 text-[9px] font-bold uppercase">Session</span><div class="flex items-baseline"><span id="dash-dist" class="text-3xl font-bold text-white dashboard-value font-mono leading-none">0.0</span><span class="text-[10px] text-accent ml-1">km</span></div></div>
            </div>

            <div class="glass-panel rounded-xl p-3 border border-slate-600 flex-none shadow-lg mt-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-slate-400 text-[10px] uppercase font-bold flex items-center gap-2"><i class="fa-solid fa-rocket text-accent"></i> Mes Apps</h3>
                    <button onclick="toggleEditMode()" id="edit-mode-btn" class="text-[9px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700 hover:text-white transition"><i class="fa-solid fa-pen"></i> Édit</button>
                </div>
                <div class="grid grid-cols-4 gap-2" id="shortcut-grid"></div>
            </div>

            <div class="glass-panel rounded-xl p-3 border border-slate-600 flex-none mt-1">
                <h3 class="text-slate-400 text-[10px] uppercase font-bold mb-2 flex justify-between">Navigation Rapide <i class="fa-brands fa-waze text-blue-400"></i></h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openNav('home')" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded flex items-center justify-center gap-2 transition active:scale-95"><i class="fa-solid fa-house text-accent text-xs"></i> <span class="text-xs font-bold">Maison</span></button>
                    <button onclick="openNav('work')" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded flex items-center justify-center gap-2 transition active:scale-95"><i class="fa-solid fa-briefcase text-warning text-xs"></i> <span class="text-xs font-bold">Travail</span></button>
                </div>
            </div>
            
            <div class="glass-panel rounded-xl p-4 border-t border-slate-600 shadow-lg flex-none mt-1">
                <div class="flex gap-2 mb-3 h-14">
                    <div class="w-1/3 flex flex-col justify-center items-center bg-slate-950/40 rounded-lg border border-slate-700 relative px-1">
                        <div class="flex justify-between items-center w-full px-1 mb-1"><span class="text-[10px] font-bold text-slate-400">GPS</span><span id="gps-status" class="text-[8px] text-slate-500">OFF</span></div>
                        <label class="relative inline-flex items-center cursor-pointer scale-90"><input type="checkbox" id="gps-toggle" class="sr-only peer" onchange="toggleGPSMode()"><div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-accent after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div></label>
                    </div>
                    <button id="btn-timer" onclick="toggleTimer()" class="flex-grow flex items-center justify-center gap-3 rounded-lg font-black text-lg transition-all bg-accent text-slate-900 hover:bg-white shadow-md active:scale-95"><i class="fa-solid fa-play"></i> <span id="timer-display">00:00:00</span></button>
                </div>
                <div class="space-y-2 bg-slate-800/40 p-3 rounded-lg border border-white/5">
                    <input type="text" id="input-title" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white focus:border-accent outline-none text-sm" placeholder="Nom du trajet (ex: Balade)">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative"><input type="number" id="input-dist" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white font-mono font-bold focus:border-accent outline-none text-base" placeholder="0.0"><span class="absolute right-3 top-2.5 text-xs text-slate-500 font-bold">km</span></div>
                        <input type="date" id="input-date" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-2 text-xs text-slate-300 outline-none text-center">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="addLog()" class="bg-slate-700 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold transition active:scale-95 shadow-lg text-xs uppercase tracking-wide"><i class="fa-solid fa-floppy-disk mr-2"></i> Save</button>
                        <button onclick="exportCurrentGPX()" id="btn-gpx" disabled class="bg-slate-800 border border-slate-600 text-slate-400 py-3 rounded-lg font-bold transition active:scale-95 shadow-lg text-xs uppercase tracking-wide disabled:opacity-50"><i class="fa-solid fa-route mr-2"></i> GPX</button>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-3 flex flex-col h-auto mb-20 mt-1 overflow-visible">
                <h3 class="text-slate-300 font-bold text-xs uppercase mb-2"><i class="fa-solid fa-list mr-1 text-accent"></i>Historique</h3>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-xs text-slate-400"><tbody id="logs-table-body" class="divide-y divide-slate-700/30"></tbody></table>
                </div>
                <div id="empty-state" class="hidden text-center py-4 text-slate-600 text-[10px] italic">Aucun trajet</div>
            </div>
        </div>

        <div id="tab-map" class="tab-content h-full relative p-0 overflow-hidden">
            <div id="map" class="w-full h-full"></div>
            <div class="hud-overlay" style="bottom: 9rem; right: 1rem; pointer-events: auto;">
                <button onclick="toggleMapTheme()" class="bg-slate-800 text-white w-10 h-10 rounded-full shadow-lg border border-slate-600 flex items-center justify-center active:scale-90 transition">
                    <i id="map-theme-icon" class="fa-solid fa-sun text-yellow-400"></i>
                </button>
            </div>

            <div class="hud-overlay hud-top-left">
                <div class="text-[10px] text-accent uppercase font-bold">Vitesse</div>
                <div class="text-6xl font-black font-mono text-white leading-none tracking-tighter" id="hud-speed">0</div>
                <div class="text-xs text-slate-300 font-bold mt-1">km/h</div>
            </div>
            <div class="hud-overlay hud-top-right">
                <div class="text-[10px] text-slate-400 uppercase font-bold">Altitude</div>
                <div class="text-2xl font-bold font-mono text-white"><span id="hud-alt">0</span><span class="text-xs text-slate-400 ml-1">m</span></div>
                <div class="text-[10px] text-slate-400 uppercase font-bold mt-2">Distance</div>
                <div class="text-2xl font-bold font-mono text-accent"><span id="hud-dist">0.0</span><span class="text-xs text-slate-400 ml-1">km</span></div>
            </div>
            <div class="hud-overlay hud-bottom-center glass-panel p-3 rounded-xl flex justify-between items-center bg-slate-900/90 border border-slate-600">
                <div class="flex items-center gap-2">
                    <div id="rec-dot" class="w-3 h-3 rounded-full bg-slate-600"></div>
                    <div class="text-white font-mono font-bold" id="hud-timer">00:00:00</div>
                </div>
                <button onclick="centerMap(true)" class="bg-accent text-slate-900 w-10 h-10 rounded-full shadow-lg active:scale-90 flex items-center justify-center font-bold"><i class="fa-solid fa-location-arrow"></i></button>
            </div>
        </div>

        <div id="tab-garage" class="tab-content h-full p-3 flex-col gap-3">
            <div class="glass-panel rounded-xl p-4 bg-slate-900/60 border border-slate-600 text-center flex-none">
                <span class="text-[10px] text-slate-400 uppercase font-bold mb-1">Odomètre Total</span>
                <div class="flex items-center justify-center gap-2 mt-2"><input type="number" id="odo-input" step="0.1" onchange="manualUpdateODO(this.value)" class="bg-transparent text-4xl font-mono font-black text-white w-40 text-center focus:outline-none border-b border-transparent focus:border-accent p-0 leading-none" placeholder="0.0"><span class="text-sm text-slate-500 font-bold">km</span></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-chart-line mr-2"></i>Statistiques (7 derniers)</h3>
                <div class="h-40 w-full relative">
                    <canvas id="rideChart"></canvas>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 relative overflow-hidden flex-none">
                <h3 class="text-white font-bold mb-4 text-xs uppercase"><i class="fa-solid fa-wrench text-warning mr-2"></i>Entretien</h3>
                <div id="maintenance-container" class="space-y-4"></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-emerald-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-money-bill-wave mr-2"></i>Calculateur Économies</h3>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><label class="text-slate-500 block mb-1">Coût Voiture</label><input type="number" id="cost-car" step="0.01" onchange="saveEcoSettings()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white w-full" placeholder="0.20"></div>
                    <div><label class="text-slate-500 block mb-1">Coût Scooter</label><input type="number" id="cost-scooter" step="0.01" onchange="saveEcoSettings()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white w-full" placeholder="0.05"></div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-map-pin mr-2"></i>Adresses Rapides</h3>
                <div class="flex flex-col gap-2">
                    <input type="text" id="addr-home" onchange="saveAddresses()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white text-xs w-full" placeholder="Maison">
                    <input type="text" id="addr-work" onchange="saveAddresses()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white text-xs w-full" placeholder="Travail">
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-lock mr-2"></i>Sécurité</h3>
                <div class="flex gap-2"><input type="number" id="new-pin-input" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm w-full outline-none" placeholder="Nouveau code"><button onclick="changeUserPin()" class="bg-slate-700 hover:bg-accent text-white px-4 py-2 rounded text-xs font-bold transition">OK</button></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none mb-6">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3">Sauvegarde</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportJSON()" class="col-span-2 bg-slate-800 hover:bg-slate-700 text-slate-200 py-3 rounded text-xs border border-slate-600 font-bold"><i class="fa-solid fa-download mr-2"></i> Sauver (JSON)</button>
                    <button onclick="document.getElementById('fileInput').click()" class="col-span-2 bg-slate-800 hover:bg-slate-700 text-slate-200 py-3 rounded text-xs border border-slate-600"><i class="fa-solid fa-upload mr-2"></i> Restaurer</button>
                    <input type="file" id="fileInput" class="hidden" onchange="importJSON(this)">
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 glass-panel border-t border-slate-700/50 h-16 z-50">
        <div class="grid grid-cols-3 h-full max-w-7xl mx-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn active flex flex-col items-center justify-center text-slate-400 hover:text-white border-t-2 border-transparent transition-all"><i class="fa-solid fa-gauge-high text-lg mb-1"></i><span class="text-[10px] font-bold uppercase">Dash</span></button>
            <button onclick="switchTab('map')" id="nav-map" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-white border-t-2 border-transparent transition-all"><i class="fa-solid fa-location-arrow text-lg mb-1"></i><span class="text-[10px] font-bold uppercase">Cockpit</span></button>
            <button onclick="switchTab('garage')" id="nav-garage" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-white border-t-2 border-transparent transition-all"><i class="fa-solid fa-wrench text-lg mb-1"></i><span class="text-[10px] font-bold uppercase">Garage</span></button>
        </div>
    </nav>

    <script>
        // --- 1. CORE & PIN ---
        setInterval(() => { const el = document.getElementById('clock-display'); if(el) el.innerText = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}); }, 1000);
        let savedPin = localStorage.getItem('scooter_pin') || "0000"; let currentPin = "";
        function typePin(d) { if(currentPin.length<4){ currentPin+=d; updatePinDots(); if(currentPin.length===4) checkPin(); } }
        function clearPin() { currentPin=""; updatePinDots(); document.getElementById('login-error').classList.add('opacity-0'); }
        function updatePinDots() { for(let i=1;i<=4;i++) document.getElementById('dot-'+i).classList.toggle('filled', i<=currentPin.length); }
        function checkPin() { if(currentPin===savedPin) document.getElementById('login-overlay').style.display='none'; else { document.getElementById('login-error').classList.remove('opacity-0'); setTimeout(clearPin,500); } }
        function changeUserPin() { const n = document.getElementById('new-pin-input').value; if(n.length===4 && confirm('Changer PIN?')) { localStorage.setItem('scooter_pin', n); savedPin=n; alert('OK'); document.getElementById('new-pin-input').value=""; } }
        
        // --- 2. DATA ---
        let state = { odo: 0, tripA: 0, tripB: 0, maintenance: null, logs: [], addresses: {home:'', work:''}, eco: {car: 0.20, scooter: 0.05}, shortcuts: [null,null,null,null] };
        
        function loadData() { 
            try { 
                const d = localStorage.getItem('trackMasterV24'); 
                if(d) {
                    const loaded = JSON.parse(d);
                    state = { ...state, ...loaded };
                    if(!state.maintenance || typeof state.maintenance !== 'object') {
                        state.maintenance = {
                            general: { last: loaded.maintenanceKm || 0, interval: loaded.maintInterval || 500 },
                            brakes: { last: state.odo, interval: 1500 },
                            tires: { last: state.odo, interval: 3000 }
                        };
                    }
                } 
                if(!state.shortcuts || !Array.isArray(state.shortcuts)) state.shortcuts = [null,null,null,null];
                if(isNaN(state.tripA)) state.tripA = 0; if(isNaN(state.tripB)) state.tripB = 0;
                updateUI(); 
            } catch(e){} 
        }
        function saveData() { localStorage.setItem('trackMasterV24', JSON.stringify(state)); }

        // --- 3. METEO & ECO & NAV ---
        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation_probability&forecast_days=1`);
                const data = await res.json();
                const temp = Math.round(data.current.temperature_2m);
                const rain = data.current.precipitation_probability;
                let icon = rain > 50 ? '<i class="fa-solid fa-cloud-showers-heavy text-blue-400"></i>' : (rain > 20 ? '<i class="fa-solid fa-cloud-rain text-blue-300"></i>' : (temp > 20 ? '<i class="fa-solid fa-sun text-yellow-400"></i>' : '<i class="fa-solid fa-cloud text-slate-300"></i>'));
                document.getElementById('top-weather').innerHTML = `${icon} <span class="text-white">${temp}°</span>`;
            } catch(e) { document.getElementById('top-weather').innerHTML = '<span class="text-[9px] text-red-400">ERR</span>'; }
        }

        function saveEcoSettings() {
            state.eco.car = parseFloat(document.getElementById('cost-car').value) || 0.20;
            state.eco.scooter = parseFloat(document.getElementById('cost-scooter').value) || 0.05;
            saveData(); updateUI();
        }

        function saveAddresses() {
            state.addresses.home = document.getElementById('addr-home').value;
            state.addresses.work = document.getElementById('addr-work').value;
            saveData();
        }

        function openNav(type) {
            const addr = state.addresses[type];
            if(!addr) return alert("Veuillez configurer l'adresse dans le Garage.");
            if(confirm("Ouvrir Waze pour aller à : " + addr + " ?")) {
                window.open(`https://waze.com/ul?q=${encodeURIComponent(addr)}&navigate=yes`, '_blank');
            } else if(confirm("Ou Google Maps ?")) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`, '_blank');
            }
        }

        // --- 4. GPS CORE & MAP THEME ---
        let map, polyline, marker, watchId, isTimerRunning=false, timerInterval, timerSeconds=0, currentTripDist=0, trackPoints=[], currentMaxSpeed=0;
        let mapTileLayer, isDarkMap = true;
        let historyPolyline = null; // Pour afficher un vieux trajet

        let wakeLock=null; async function requestWakeLock(){ if('wakeLock' in navigator) try{ wakeLock=await navigator.wakeLock.request('screen'); document.getElementById('wake-icon').classList.add('wake-active'); }catch(e){} }
        
        window.onload = function() { loadData(); document.getElementById('input-date').valueAsDate = new Date(); initMap(); requestWakeLock(); };

        function initMap() { 
            map = L.map('map', {zoomControl:false}).setView([48.85, 2.35], 16);
            mapTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {maxZoom: 20}).addTo(map);
            const arrowIcon = L.divIcon({ className:'custom-div-icon', html:"<div class='nav-arrow-container'><div id='gps-arrow' class='nav-arrow'></div></div>", iconSize:[40,40], iconAnchor:[20,20] });
            marker = L.marker([0,0], {icon: arrowIcon}).addTo(map);
            polyline = L.polyline([], {color:'#10b981', weight:5}).addTo(map);
            historyPolyline = L.polyline([], {color:'#06b6d4', weight:5, dashArray: '10, 10'}).addTo(map); // Cyan pour l'historique
        }

        function toggleMapTheme() {
            isDarkMap = !isDarkMap;
            const url = isDarkMap 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            mapTileLayer.setUrl(url);
            const btn = document.getElementById('map-theme-icon');
            if(isDarkMap) { btn.className = "fa-solid fa-sun text-yellow-400"; document.getElementById('map').classList.remove('brightness-125'); } 
            else { btn.className = "fa-solid fa-moon text-slate-300"; }
        }

        function centerMap() { if(!navigator.geolocation) return alert("Pas de GPS"); navigator.geolocation.getCurrentPosition(p=>{map.setView([p.coords.latitude, p.coords.longitude], 18);}); }

        function toggleGPSMode() {
            if(document.getElementById('gps-toggle').checked) {
                if(!navigator.geolocation) return alert("GPS HS");
                requestWakeLock();
                navigator.geolocation.getCurrentPosition(p => fetchWeather(p.coords.latitude, p.coords.longitude));
                
                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    const spd = pos.coords.speed ? Math.round(pos.coords.speed*3.6) : 0;
                    const alt = pos.coords.altitude ? Math.round(pos.coords.altitude) : 0;
                    const heading = pos.coords.heading || 0;
                    
                    document.getElementById('gps-status').innerText = "ON"; document.getElementById('gps-status').className = "text-emerald-400 font-bold text-[8px]";
                    document.getElementById('dash-speed').innerText = spd; document.getElementById('hud-speed').innerText = spd;
                    document.getElementById('hud-alt').innerText = alt;
                    marker.setLatLng([lat,lon]);
                    const arrow = document.getElementById('gps-arrow'); if(arrow) arrow.style.transform = `rotate(${heading}deg)`;
                    map.setView([lat,lon]);

                    if(isTimerRunning) {
                        if(spd > currentMaxSpeed) currentMaxSpeed = spd;
                        if(pos.coords.accuracy && pos.coords.accuracy > 40) return; // Filter bad GPS
                        trackPoints.push({lat, lon, ele: alt, time: new Date()});
                        polyline.addLatLng([lat,lon]);
                        if(trackPoints.length > 1) {
                            const last = trackPoints[trackPoints.length-2];
                            const d = 6371 * 2 * Math.atan2(Math.sqrt(Math.sin((lat-last.lat)*Math.PI/360)**2 + Math.cos(last.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lon-last.lon)*Math.PI/360)**2), Math.sqrt(1-Math.sin((lat-last.lat)*Math.PI/360)**2 - Math.cos(last.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lon-last.lon)*Math.PI/360)**2));
                            if(d > 0.002) { 
                                currentTripDist += d; 
                                document.getElementById('dash-dist').innerText = currentTripDist.toFixed(2); 
                                document.getElementById('hud-dist').innerText = currentTripDist.toFixed(1); 
                                document.getElementById('input-dist').value = currentTripDist.toFixed(2); 
                            }
                        }
                        document.getElementById('btn-gpx').disabled = false; document.getElementById('btn-gpx').classList.remove('text-slate-400'); document.getElementById('btn-gpx').classList.add('text-white', 'border-accent');
                    }
                }, err => {}, {enableHighAccuracy:true});
            } else { navigator.geolocation.clearWatch(watchId); document.getElementById('gps-status').innerText = "OFF"; document.getElementById('dash-speed').innerText = "0"; document.getElementById('hud-speed').innerText = "0"; }
        }

        function toggleTimer() {
            const btn = document.getElementById('btn-timer'); const rec = document.getElementById('rec-dot');
            if(!isTimerRunning) {
                // START
                isTimerRunning=true; timerSeconds=0; currentTripDist=0; currentMaxSpeed=0; trackPoints=[]; 
                polyline.setLatLngs([]); // Reset current live line
                if(historyPolyline) historyPolyline.setLatLngs([]); // Reset history view if any
                btn.classList.replace('bg-accent','bg-red-500'); btn.classList.replace('text-slate-900','text-white');
                rec.classList.replace('bg-slate-600', 'bg-red-500'); rec.classList.add('animate-pulse');
                if(!document.getElementById('gps-toggle').checked) { document.getElementById('gps-toggle').checked=true; toggleGPSMode(); }
                timerInterval = setInterval(()=>{ timerSeconds++; const h=Math.floor(timerSeconds/3600), m=Math.floor((timerSeconds%3600)/60), s=timerSeconds%60; const txt=`${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`; document.getElementById('timer-display').innerText=txt; document.getElementById('hud-timer').innerText=txt; }, 1000);
            } else { 
                // STOP
                isTimerRunning=false; clearInterval(timerInterval); 
                btn.classList.replace('bg-red-500','bg-accent'); btn.classList.replace('text-white','text-slate-900'); 
                rec.classList.replace('bg-red-500', 'bg-slate-600'); rec.classList.remove('animate-pulse'); 
            }
        }
        
        // --- 5. LOG & HISTORY LOGIC ---
        function addLog() { 
            if(isTimerRunning) toggleTimer(); 
            const dist = parseFloat(document.getElementById('input-dist').value); if(!dist || dist<=0) return alert("0 km ?"); 
            state.odo += dist; 
            state.tripA += dist;
            state.tripB += dist;
            
            // SAUVEGARDE DES POINTS GPS
            const savedTrack = [...trackPoints]; 

            state.logs.unshift({
                id: Date.now(), 
                title: document.getElementById('input-title').value||"Trajet", 
                date: document.getElementById('input-date').value, 
                dist: dist.toFixed(1), 
                max: currentMaxSpeed,
                track: savedTrack // On sauve le tracé ici
            }); 

            saveData(); updateUI(); 
            // Reset
            document.getElementById('input-dist').value = ""; document.getElementById('timer-display').innerText="00:00:00"; document.getElementById('hud-dist').innerText="0.0"; document.getElementById('hud-timer').innerText="00:00:00";
            document.getElementById('btn-gpx').disabled = true; document.getElementById('btn-gpx').classList.add('text-slate-400'); document.getElementById('btn-gpx').classList.remove('text-white', 'border-accent');
        }

        // --- NOUVELLES FONCTIONS HISTORIQUE ---
        function viewOnMap(id) {
            const log = state.logs.find(l => l.id === id);
            if(!log || !log.track || log.track.length === 0) return alert("Pas de données GPS pour ce trajet.");
            
            switchTab('map');
            const latlngs = log.track.map(p => [p.lat, p.lon]);
            if(historyPolyline) historyPolyline.setLatLngs(latlngs);
            map.fitBounds(historyPolyline.getBounds());
        }

        function downloadLogGPX(id) {
            const log = state.logs.find(l => l.id === id);
            if(!log || !log.track || log.track.length === 0) return alert("Pas de données GPS pour ce trajet.");
            
            let gpx = `<?xml version="1.0"?><gpx version="1.1"><trk><name>${log.title}</name><trkseg>`;
            log.track.forEach(p => {
                // Ensure time is ISO string
                const t = new Date(p.time).toISOString();
                gpx += `<trkpt lat="${p.lat}" lon="${p.lon}"><ele>${p.ele}</ele><time>${t}</time></trkpt>`;
            });
            gpx += `</trkseg></trk></gpx>`;
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([gpx],{type:'application/gpx+xml'}));
            a.download = `${log.title.replace(/\s+/g,'_')}_${log.date}.gpx`;
            a.click();
        }

        function resetTrip(type) {
            if(confirm('Remettre Trip ' + type + ' à zéro ?')) {
                if(type === 'A') state.tripA = 0;
                if(type === 'B') state.tripB = 0;
                saveData(); updateUI();
            }
        }

        function resetMultiMaint(key) {
            if(confirm('Valider entretien : ' + key.toUpperCase() + ' ?')) {
                state.maintenance[key].last = state.odo;
                saveData(); updateUI();
            }
        }
        function setMaintInterval(key) {
            const current = state.maintenance[key].interval;
            const newVal = prompt("Nouvel intervalle pour " + key + " (km):", current);
            if(newVal && !isNaN(newVal)) {
                state.maintenance[key].interval = parseFloat(newVal);
                saveData(); updateUI();
            }
        }

        // --- 6. CHART ---
        let chartInstance = null;
        function renderChart() {
            const ctx = document.getElementById('rideChart');
            if(!ctx) return;
            const dataLogs = state.logs.slice(0, 7).reverse();
            const labels = dataLogs.map(l => l.date.substring(5)); 
            const distances = dataLogs.map(l => parseFloat(l.dist));
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Km', data: distances, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', borderWidth: 2, tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8', font: {size:8} } }, x: { display: true, grid: { display: false }, ticks: { color: '#94a3b8', font: {size:8} } } } } });
        }

        // Utils
        function exportCurrentGPX() { if(trackPoints.length<2) return alert("Pas de trajet"); let gpx=`<?xml version="1.0"?><gpx version="1.1"><trk><trkseg>`; trackPoints.forEach(p=>{gpx+=`<trkpt lat="${p.lat}" lon="${p.lon}"><ele>${p.ele}</ele><time>${p.time.toISOString()}</time></trkpt>`;}); gpx+=`</trkseg></trk></gpx>`; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([gpx],{type:'application/gpx+xml'})); a.download=`Trajet.gpx`; a.click(); }
        function exportJSON() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state)); a.download="backup.json"; a.click(); }
        function importJSON(i) { const r=new FileReader(); r.onload=e=>{ state={...state, ...JSON.parse(e.target.result)}; saveData(); updateUI(); alert("OK"); }; r.readAsText(i.files[0]); }
        function deleteLog(id) { if(confirm('Supprimer ?')) { const i=state.logs.findIndex(l=>l.id===id); if(i>-1) { state.odo-=parseFloat(state.logs[i].dist); state.logs.splice(i,1); saveData(); updateUI(); } } }
        function manualUpdateODO(v) { state.odo = parseFloat(v); saveData(); updateUI(); }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+id).classList.add('active'); if(id==='map') setTimeout(()=>{ if(map) { map.invalidateSize(); centerMap(); } },200); if(id==='garage') renderChart(); } 

        // Apps
        let isEditMode = false, currentSlotIndex = -1;
        function renderShortcuts() {
            const grid = document.getElementById('shortcut-grid'); if (!grid) return; grid.innerHTML = '';
            state.shortcuts.forEach((app, index) => {
                const btn = document.createElement('div');
                if (app) {
                    let action = isEditMode ? `openAppModal(${index})` : `window.location.href='${app.url}'`;
                    if (!isEditMode && app.url.startsWith('http')) { action = `window.open('${app.url}', '_blank')`; }
                    btn.className = `relative h-16 rounded-xl flex flex-col items-center justify-center gap-1 transition active:scale-95 cursor-pointer overflow-hidden border ${isEditMode ? 'border-yellow-500 bg-yellow-500/10 animate-pulse' : 'border-slate-700 bg-slate-800/50 hover:bg-slate-700'}`;
                    btn.setAttribute('onclick', action);
                    btn.style.borderColor = isEditMode ? '#eab308' : (app.color + '40');
                    btn.innerHTML = `<i class="${app.icon} text-xl mb-1" style="color: ${app.color}"></i><span class="text-[8px] font-bold text-slate-300 truncate w-full text-center px-1">${app.name}</span>${isEditMode ? '<div class="absolute top-1 right-1 text-[8px] text-yellow-500"><i class="fa-solid fa-pencil"></i></div>' : ''}`;
                } else {
                    btn.className = "h-16 rounded-xl border border-dashed border-slate-700 flex items-center justify-center text-slate-600 hover:text-accent hover:border-accent transition cursor-pointer active:scale-95 bg-slate-900/30";
                    btn.onclick = () => openAppModal(index);
                    btn.innerHTML = `<i class="fa-solid fa-plus text-lg"></i>`;
                }
                grid.appendChild(btn);
            });
        }
        function toggleEditMode() { isEditMode = !isEditMode; const btn = document.getElementById('edit-mode-btn'); if (isEditMode) { btn.classList.add('bg-yellow-500', 'text-slate-900', 'border-yellow-600'); btn.classList.remove('bg-slate-800', 'text-slate-500'); btn.innerHTML = '<i class="fa-solid fa-check"></i> OK'; } else { btn.classList.remove('bg-yellow-500', 'text-slate-900', 'border-yellow-600'); btn.classList.add('bg-slate-800', 'text-slate-500'); btn.innerHTML = '<i class="fa-solid fa-pen"></i> Édit'; } renderShortcuts(); }
        function openAppModal(index) { currentSlotIndex = index; const modal = document.getElementById('app-modal'); const existing = state.shortcuts[index]; document.getElementById('app-select').value = 'custom'; if (existing) { document.getElementById('app-name').value = existing.name; document.getElementById('app-url').value = existing.url; document.getElementById('app-icon').value = existing.icon; document.getElementById('app-color').value = existing.color; document.getElementById('btn-delete-app').classList.remove('hidden'); } else { document.getElementById('app-name').value = ""; document.getElementById('app-url').value = ""; document.getElementById('app-icon').value = "fa-solid fa-cube"; document.getElementById('app-color').value = "#ffffff"; document.getElementById('btn-delete-app').classList.add('hidden'); } modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeAppModal() { document.getElementById('app-modal').classList.add('hidden'); document.getElementById('app-modal').classList.remove('flex'); }
        function prefillApp() { const val = document.getElementById('app-select').value; if (val === 'custom') return; const [name, url, icon, color] = val.split('|'); document.getElementById('app-name').value = name; document.getElementById('app-url').value = url; document.getElementById('app-icon').value = icon; document.getElementById('app-color').value = color; }
        function saveShortcut() { const name = document.getElementById('app-name').value; const url = document.getElementById('app-url').value; const icon = document.getElementById('app-icon').value; const color = document.getElementById('app-color').value; if (!name || !url) return alert("Nom et lien requis"); state.shortcuts[currentSlotIndex] = { name, url, icon, color }; saveData(); renderShortcuts(); closeAppModal(); if(isEditMode) toggleEditMode(); }
        function deleteCurrentShortcut() { if(confirm('Supprimer ce raccourci ?')) { state.shortcuts[currentSlotIndex] = null; saveData(); renderShortcuts(); closeAppModal(); } }

        function updateUI() { 
            if(document.getElementById('odo-input')) document.getElementById('odo-input').value = state.odo.toFixed(1);
            document.getElementById('disp-odo-total').innerText = state.odo.toFixed(1);
            document.getElementById('disp-trip-a').innerText = (state.tripA || 0).toFixed(1);
            document.getElementById('disp-trip-b').innerText = (state.tripB || 0).toFixed(1);

            const cont = document.getElementById('maintenance-container');
            if(cont && state.maintenance) {
                cont.innerHTML = '';
                const keys = { general: 'Général', brakes: 'Freins', tires: 'Pneus' };
                const icons = { general: 'fa-wrench', brakes: 'fa-circle-stop', tires: 'fa-road' };
                for (const [key, label] of Object.entries(keys)) {
                    const item = state.maintenance[key];
                    const diff = state.odo - item.last;
                    const pct = Math.min(100, (diff / item.interval) * 100);
                    const isAlert = diff >= item.interval;
                    cont.innerHTML += `
                    <div class="mb-2">
                        <div class="flex justify-between text-xs text-slate-300 mb-1">
                            <span><i class="fa-solid ${icons[key]} text-[10px] mr-1 text-slate-500"></i>${label}</span>
                            <span class="cursor-pointer hover:text-white" onclick="setMaintInterval('${key}')">${diff.toFixed(0)} / ${item.interval}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex-grow overflow-hidden h-2 rounded-full bg-slate-700">
                                <div style="width: ${pct}%" class="h-full transition-all duration-500 ${isAlert ? 'bg-red-500 animate-pulse' : 'bg-accent'}"></div>
                            </div>
                            <button onclick="resetMultiMaint('${key}')" class="text-[9px] bg-slate-700 px-2 py-0.5 rounded text-white hover:bg-accent hover:text-black font-bold">FAIT</button>
                        </div>
                    </div>`;
                }
            }
            
            document.getElementById('savings-display').innerText = ((state.eco.car - state.eco.scooter) * state.odo).toFixed(0);
            document.getElementById('cost-car').value = state.eco.car; document.getElementById('cost-scooter').value = state.eco.scooter;
            document.getElementById('addr-home').value = state.addresses.home || ""; document.getElementById('addr-work').value = state.addresses.work || "";

            const tb = document.getElementById('logs-table-body'); 
            if(tb) { 
                tb.innerHTML=''; 
                if(state.logs.length===0) document.getElementById('empty-state').classList.remove('hidden'); 
                else { 
                    document.getElementById('empty-state').classList.add('hidden'); 
                    state.logs.forEach(l => { 
                        // Vérifier si des données GPS existent pour ce log
                        const hasTrack = l.track && l.track.length > 0;
                        const opacityClass = hasTrack ? 'opacity-100 hover:text-white' : 'opacity-30 cursor-not-allowed';
                        
                        const tr = document.createElement('tr'); 
                        tr.innerHTML = `
                        <td class="py-2 px-1">
                            <div class="font-bold text-slate-200">${l.title}</div>
                            <div class="text-[9px] text-slate-500">${l.date}</div>
                        </td>
                        <td class="py-2 px-1 text-right">
                            <div class="text-accent font-bold">+${l.dist}</div>
                            <div class="text-[9px] text-slate-500">Max ${l.max||0} km/h</div>
                        </td>
                        <td class="py-2 px-1 text-right flex justify-end gap-2 items-center h-full pt-3">
                            <button onclick="viewOnMap(${l.id})" class="text-cyan-400 ${opacityClass}" title="Voir sur carte"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="downloadLogGPX(${l.id})" class="text-emerald-400 ${opacityClass}" title="Télécharger GPX"><i class="fa-solid fa-floppy-disk"></i></button>
                            <button onclick="deleteLog(${l.id})" class="text-slate-600 hover:text-red-500 ml-1"><i class="fa-solid fa-trash"></i></button>
                        </td>`; 
                        tb.appendChild(tr); 
                    }); 
                } 
            }
            renderShortcuts();
            if(document.getElementById('tab-garage').classList.contains('active')) renderChart();
        }
    </script>
</body>
</html>