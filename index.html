<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2641/2641271.png">
    
    <title>ScooterMaster V37</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { slate: { 850: '#151f32', 900: '#0f172a' }, accent: 'var(--accent-color)', danger: '#ef4444', warning: '#f59e0b', info: '#3b82f6' }, fontFamily: { mono: ['ui-monospace', 'monospace'] } } } }
    </script>

    <style>
        :root { --accent-color: #10b981; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .digital-clock { text-shadow: 0 0 15px var(--accent-color); letter-spacing: -1px; transition: text-shadow 0.3s; }
        .dashboard-value { text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #map { height: 100%; width: 100%; border-radius: 0; z-index: 1; }
        .wake-active { color: #fbbf24; text-shadow: 0 0 10px #fbbf24; }
        .nav-arrow { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid var(--accent-color); filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); transition: transform 0.3s ease; }
        .nav-arrow-container { display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; background: rgba(15, 23, 42, 0.5); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        /* Z-INDEX LAYERS */
        #login-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: opacity 0.5s; }
        #calc-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #app-modal { position: fixed; inset: 0; z-index: 9500; display: none; backdrop-filter: blur(5px); background: rgba(15, 23, 42, 0.9); justify-content: center; items-items: center; }
        #app-modal.flex { display: flex; }

        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #334155; transition: all 0.2s; }
        .pin-dot.filled { background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }
        .numpad-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid #334155; color: white; font-size: 24px; display: flex; items-center; justify-content: center; transition: all 0.1s; background: rgba(30, 41, 59, 0.5); }
        .numpad-btn:active { background: var(--accent-color); color: #0f172a; border-color: var(--accent-color); transform: scale(0.95); }
        .calc-btn { width: 100%; height: 50px; border-radius: 12px; border: 1px solid #334155; font-size: 20px; font-weight: bold; background: rgba(30, 41, 59, 0.6); color: white; }
        .calc-btn:active { background: var(--accent-color); color: #0f172a; }
        #login-error { transition: opacity 0.3s; opacity: 0; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        .tab-content { display: none; flex-direction: column; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6rem; }
        .tab-content.active { display: flex; }
        .nav-btn.active { color: var(--accent-color); background: rgba(255, 255, 255, 0.05); border-color: var(--accent-color); }
        .hud-overlay { position: absolute; z-index: 500; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none; }
        .hud-top-left { top: 1rem; left: 1rem; }
        .hud-top-right { top: 1rem; right: 1rem; text-align: right; }
        .hud-bottom-center { bottom: 6rem; left: 50%; transform: translateX(-50%); width: 90%; pointer-events: auto; }
        
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot:active { transform: scale(0.9); }
        .color-dot.selected { border-color: white; transform: scale(1.1); }
    </style>
</head>
<body onclick="requestWakeLock()"> 

    <input type="file" id="camera-trigger" accept="image/*" capture="environment" class="hidden">

    <div id="login-overlay">
        <div class="mb-8 flex flex-col items-center">
            <i class="fa-solid fa-crown text-4xl text-accent mb-4"></i>
            <h2 class="text-white font-bold text-xl uppercase tracking-widest">Ultimate V37</h2>
            <p class="text-slate-500 text-xs mt-1">Code PIN requis</p>
            <p id="login-error" class="text-red-500 text-xs font-bold mt-2">Code Incorrect</p>
        </div>
        <div class="flex gap-4 mb-8"><div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div></div>
        <div class="grid grid-cols-3 gap-6">
            <button class="numpad-btn" onclick="typePin(1)">1</button><button class="numpad-btn" onclick="typePin(2)">2</button><button class="numpad-btn" onclick="typePin(3)">3</button>
            <button class="numpad-btn" onclick="typePin(4)">4</button><button class="numpad-btn" onclick="typePin(5)">5</button><button class="numpad-btn" onclick="typePin(6)">6</button>
            <button class="numpad-btn" onclick="typePin(7)">7</button><button class="numpad-btn" onclick="typePin(8)">8</button><button class="numpad-btn" onclick="typePin(9)">9</button>
            <div class="w-[60px]"></div><button class="numpad-btn" onclick="typePin(0)">0</button><button class="numpad-btn text-red-400 border-red-900/50" onclick="clearPin()"><i class="fa-solid fa-delete-left"></i></button>
        </div>
    </div>

    <div id="calc-overlay">
        <div class="glass-panel p-4 rounded-2xl w-full max-w-xs border border-slate-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold text-sm"><i class="fa-solid fa-calculator text-accent mr-2"></i>Calculatrice</h3>
                <button onclick="document.getElementById('calc-overlay').style.display='none'" class="text-red-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="bg-slate-900 border border-slate-700 rounded-lg p-3 mb-4 text-right text-2xl font-mono text-white h-12 overflow-hidden" id="calc-display">0</div>
            <div class="grid grid-cols-4 gap-2">
                <button class="calc-btn text-red-400" onclick="calcAction('C')">C</button>
                <button class="calc-btn" onclick="calcAction('(')">(</button>
                <button class="calc-btn" onclick="calcAction(')')">)</button>
                <button class="calc-btn text-accent" onclick="calcAction('/')">÷</button>
                <button class="calc-btn" onclick="calcAction('7')">7</button>
                <button class="calc-btn" onclick="calcAction('8')">8</button>
                <button class="calc-btn" onclick="calcAction('9')">9</button>
                <button class="calc-btn text-accent" onclick="calcAction('*')">×</button>
                <button class="calc-btn" onclick="calcAction('4')">4</button>
                <button class="calc-btn" onclick="calcAction('5')">5</button>
                <button class="calc-btn" onclick="calcAction('6')">6</button>
                <button class="calc-btn text-accent" onclick="calcAction('-')">-</button>
                <button class="calc-btn" onclick="calcAction('1')">1</button>
                <button class="calc-btn" onclick="calcAction('2')">2</button>
                <button class="calc-btn" onclick="calcAction('3')">3</button>
                <button class="calc-btn text-accent" onclick="calcAction('+')">+</button>
                <button class="calc-btn" onclick="calcAction('0')">0</button>
                <button class="calc-btn" onclick="calcAction('.')">.</button>
                <button class="calc-btn text-slate-400" onclick="calcAction('back')">⌫</button>
                <button class="calc-btn bg-accent text-slate-900 border-accent" onclick="calcAction('=')">=</button>
            </div>
        </div>
    </div>

    <div id="app-modal">
        <div class="glass-panel w-full max-w-sm p-5 rounded-2xl border border-slate-600 shadow-2xl relative">
            <h3 class="text-white font-bold text-lg mb-4 text-center">Ajouter un raccourci</h3>
            <label class="block text-xs text-slate-400 mb-1">Type d'application</label>
            <select id="app-select" onchange="prefillApp()" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white mb-3 outline-none focus:border-accent">
                <option value="custom">-- Choisir --</option>
                <option value="action_camera|Caméra (Interne)|action_camera|fa-solid fa-camera|#ffffff">Appareil Photo (Direct)</option>
                <option value="action_calc|Calculatrice (Interne)|action_calc|fa-solid fa-calculator|#fbbf24">Calculatrice (Interne)</option>
                <option value="spotify|Spotify|spotify:|fa-brands fa-spotify|#1DB954">Spotify</option>
                <option value="deezer|Deezer|deezer:|fa-brands fa-deezer|#a255ff">Deezer</option>
                <option value="waze|Waze|https://waze.com/ul|fa-brands fa-waze|#3b82f6">Waze</option>
                <option value="maps|Maps|https://maps.google.com|fa-solid fa-map-location-dot|#10b981">Google Maps</option>
                <option value="tel|Téléphone|tel:|fa-solid fa-phone|#ffffff">Téléphone</option>
            </select>
            <label class="block text-xs text-slate-400 mb-1">Nom</label>
            <input type="text" id="app-name" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white mb-3 outline-none text-sm">
            <label class="block text-xs text-slate-400 mb-1">Lien / Action</label>
            <input type="text" id="app-url" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white mb-3 outline-none text-xs font-mono" disabled>
            <input type="hidden" id="app-icon" value="fa-solid fa-cube">
            <input type="hidden" id="app-color" value="#ffffff">
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="closeAppModal()" class="bg-slate-700 text-slate-300 py-3 rounded-xl font-bold">Annuler</button>
                <button onclick="saveShortcut()" class="bg-accent text-slate-900 py-3 rounded-xl font-bold">Sauver</button>
            </div>
            <button id="btn-delete-app" onclick="deleteCurrentShortcut()" class="w-full mt-3 py-2 text-red-400 text-xs border border-red-900/50 rounded hover:bg-red-900/20 hidden">Supprimer</button>
        </div>
    </div>

    <nav class="glass-panel sticky top-0 z-50 border-b border-slate-700/50 pt-safe-top h-16 flex-none flex justify-between items-center px-4">
        <div class="flex items-center gap-2 text-slate-500 z-10 w-20"><i class="fa-solid fa-bolt text-accent"></i> <span class="text-[10px] font-bold uppercase tracking-wider">V37</span></div>
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center gap-3"><div class="text-3xl font-black text-white digital-clock font-mono" id="clock-display">--:--</div></div>
        <div class="flex items-center justify-end gap-3 z-10 w-auto">
            <div id="top-weather" class="flex items-center gap-2 text-xs font-bold text-slate-300"><span class="text-[9px] opacity-50">GPS?</span></div>
            <div class="h-4 w-[1px] bg-slate-700"></div>
            <i id="wake-icon" class="fa-solid fa-lightbulb text-slate-600 text-sm transition-colors duration-500"></i>
        </div>
    </nav>

    <main class="flex-grow relative w-full max-w-7xl mx-auto overflow-hidden">
        
        <div id="tab-dashboard" class="tab-content active p-3 gap-3">
            
            <div class="grid grid-cols-4 gap-2 flex-none h-18">
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center bg-slate-800/40">
                    <span class="text-[8px] text-slate-500 uppercase font-bold">Total</span>
                    <div class="font-mono font-bold text-white text-sm"><span id="disp-odo-total">0.0</span></div>
                    <span class="text-[7px] text-slate-500">km</span>
                </div>
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center relative">
                    <span class="text-[8px] text-accent uppercase font-bold">Trip A</span>
                    <div class="font-mono font-bold text-white text-sm"><span id="disp-trip-a">0.0</span></div>
                    <button onclick="resetTrip('A')" class="absolute top-1 right-1 text-[8px] text-slate-600 hover:text-red-400 p-1"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center relative">
                    <span class="text-[8px] text-warning uppercase font-bold">Trip B</span>
                    <div class="font-mono font-bold text-white text-sm"><span id="disp-trip-b">0.0</span></div>
                    <button onclick="resetTrip('B')" class="absolute top-1 right-1 text-[8px] text-slate-600 hover:text-red-400 p-1"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <div class="glass-panel rounded-xl p-1 flex flex-col items-center justify-center bg-emerald-900/20 border border-emerald-500/30">
                    <i class="fa-solid fa-piggy-bank text-emerald-400 text-sm mb-1"></i>
                    <div class="text-[10px] font-bold text-white"><span id="savings-display">0</span> €</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 flex-none h-16">
                <div class="glass-panel rounded-xl p-2 flex flex-col justify-center bg-slate-800/40 border-l-2 border-l-slate-600">
                    <span class="text-[9px] text-slate-400 uppercase font-bold flex items-center gap-1"><i class="fa-solid fa-battery-half text-accent"></i> Autonomie</span>
                    <div class="flex items-baseline mt-1">
                        <span id="batt-range-dash" class="text-2xl font-bold text-white font-mono leading-none">0</span>
                        <span class="text-[10px] text-slate-400 ml-1">km</span>
                    </div>
                </div>
                <div class="glass-panel rounded-xl p-1 grid grid-cols-2 gap-1 bg-slate-800/20">
                    <button onclick="openNav('home')" class="bg-slate-700/50 hover:bg-slate-600 text-white rounded flex flex-col items-center justify-center transition active:scale-95"><i class="fa-solid fa-house text-accent text-xs"></i><span class="text-[7px] font-bold mt-0.5">Maison</span></button>
                    <button onclick="openNav('work')" class="bg-slate-700/50 hover:bg-slate-600 text-white rounded flex flex-col items-center justify-center transition active:scale-95"><i class="fa-solid fa-briefcase text-warning text-xs"></i><span class="text-[7px] font-bold mt-0.5">Travail</span></button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 flex-none">
                <div class="glass-panel rounded-xl p-2 flex flex-col items-center justify-center bg-slate-800/60 border-l-2 border-l-accent">
                    <span class="text-slate-500 text-[9px] font-bold uppercase">Vitesse</span>
                    <div class="flex items-baseline"><span id="dash-speed" class="text-3xl font-bold text-white dashboard-value font-mono leading-none">0</span><span class="text-[10px] text-accent ml-1">km/h</span></div>
                </div>
                <div class="glass-panel rounded-xl p-2 flex flex-col items-center justify-center bg-slate-800/60 border-r-2 border-r-accent">
                    <span class="text-slate-500 text-[9px] font-bold uppercase">Session</span>
                    <div class="flex items-baseline"><span id="dash-dist" class="text-3xl font-bold text-white dashboard-value font-mono leading-none">0.0</span><span class="text-[10px] text-accent ml-1">km</span></div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-3 border-t border-slate-600 shadow-lg flex-none mt-1">
                <div class="flex gap-2 mb-3 h-12">
                    <div class="w-1/3 flex flex-col justify-center items-center bg-slate-950/40 rounded-lg border border-slate-700 relative px-1">
                        <div class="flex justify-between items-center w-full px-1 mb-1"><span class="text-[10px] font-bold text-slate-400">GPS</span><span id="gps-status" class="text-[8px] text-slate-500">OFF</span></div>
                        <label class="relative inline-flex items-center cursor-pointer scale-90"><input type="checkbox" id="gps-toggle" class="sr-only peer" onchange="toggleGPSMode()"><div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-accent after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div></label>
                    </div>
                    <button id="btn-timer" onclick="toggleTimer()" class="flex-grow flex items-center justify-center gap-3 rounded-lg font-black text-lg transition-all bg-accent text-slate-900 hover:bg-white shadow-md active:scale-95"><i class="fa-solid fa-play"></i> <span id="timer-display">00:00:00</span></button>
                </div>
                <div class="space-y-2 bg-slate-800/40 p-2 rounded-lg border border-white/5">
                    <input type="text" id="input-title" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white focus:border-accent outline-none text-xs" placeholder="Nom du trajet (ex: Balade)">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative"><input type="number" id="input-dist" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-white font-mono font-bold focus:border-accent outline-none text-base" placeholder="0.0"><span class="absolute right-3 top-2.5 text-xs text-slate-500 font-bold">km</span></div>
                        <input type="date" id="input-date" class="w-full bg-slate-900 border border-slate-700 rounded px-1 py-1.5 text-xs text-slate-300 outline-none text-center">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="addLog()" class="bg-slate-700 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold transition active:scale-95 shadow-lg text-xs uppercase tracking-wide"><i class="fa-solid fa-floppy-disk mr-2"></i> Save</button>
                        <button onclick="exportCurrentGPX()" id="btn-gpx" disabled class="bg-slate-800 border border-slate-600 text-slate-400 py-3 rounded-lg font-bold transition active:scale-95 shadow-lg text-xs uppercase tracking-wide disabled:opacity-50"><i class="fa-solid fa-route mr-2"></i> GPX</button>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-2 border border-slate-600 flex-none shadow-lg mt-1 relative">
                <div class="grid grid-cols-4 gap-2" id="shortcut-grid-main"></div>
                <button onclick="toggleEditMode('main')" id="edit-mode-btn-main" class="absolute top-1 right-1 text-[8px] text-slate-600 hover:text-white p-1"><i class="fa-solid fa-pen"></i></button>
            </div>

            <div class="glass-panel rounded-xl p-2 border border-slate-600 flex-none shadow-lg mt-1 relative">
                <div class="grid grid-cols-4 gap-2" id="shortcut-grid-mini"></div>
                <button onclick="toggleEditMode('mini')" id="edit-mode-btn-mini" class="absolute top-1 right-1 text-[8px] text-slate-600 hover:text-white p-1"><i class="fa-solid fa-pen"></i></button>
            </div>

            <div class="glass-panel rounded-xl p-3 flex flex-col h-auto mb-20 mt-1 overflow-visible">
                <h3 class="text-slate-300 font-bold text-xs uppercase mb-2"><i class="fa-solid fa-list mr-1 text-accent"></i>Historique</h3>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-xs text-slate-400"><tbody id="logs-table-body" class="divide-y divide-slate-700/30"></tbody></table>
                </div>
                <div id="empty-state" class="hidden text-center py-4 text-slate-600 text-[10px] italic">Aucun trajet</div>
            </div>
        </div>

        <div id="tab-map" class="tab-content h-full relative p-0 overflow-hidden">
            <div id="map" class="w-full h-full"></div>
            <div class="hud-overlay" style="bottom: 9rem; right: 1rem; pointer-events: auto;">
                <button onclick="toggleMapTheme()" class="bg-slate-800 text-white w-10 h-10 rounded-full shadow-lg border border-slate-600 flex items-center justify-center active:scale-90 transition"><i id="map-theme-icon" class="fa-solid fa-sun text-yellow-400"></i></button>
            </div>
            <div class="hud-overlay hud-top-left">
                <div class="text-[10px] text-accent uppercase font-bold">Vitesse</div>
                <div class="text-6xl font-black font-mono text-white leading-none tracking-tighter" id="hud-speed">0</div>
                <div class="text-xs text-slate-300 font-bold mt-1">km/h</div>
            </div>
            <div class="hud-overlay hud-top-right">
                <div class="text-[10px] text-slate-400 uppercase font-bold">Altitude</div>
                <div class="text-2xl font-bold font-mono text-white"><span id="hud-alt">0</span><span class="text-xs text-slate-400 ml-1">m</span></div>
                <div class="text-[10px] text-slate-400 uppercase font-bold mt-2">Distance</div>
                <div class="text-2xl font-bold font-mono text-accent"><span id="hud-dist">0.0</span><span class="text-xs text-slate-400 ml-1">km</span></div>
                
                <div class="text-[10px] text-slate-400 uppercase font-bold mt-2">Autonomie</div>
                <div class="text-2xl font-bold font-mono text-white"><span id="hud-range">0.0</span><span class="text-xs text-accent ml-1">km</span></div>
            </div>
            <div class="hud-overlay hud-bottom-center glass-panel p-3 rounded-xl flex justify-between items-center bg-slate-900/90 border border-slate-600">
                <div class="flex items-center gap-2">
                    <div id="rec-dot" class="w-3 h-3 rounded-full bg-slate-600"></div>
                    <div class="text-white font-mono font-bold" id="hud-timer">00:00:00</div>
                </div>
                <button onclick="centerMap(true)" class="bg-accent text-slate-900 w-10 h-10 rounded-full shadow-lg active:scale-90 flex items-center justify-center font-bold"><i class="fa-solid fa-location-arrow"></i></button>
            </div>
        </div>

        <div id="tab-garage" class="tab-content h-full p-3 flex-col gap-3">
            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-white text-xs uppercase font-bold mb-3"><i class="fa-solid fa-palette mr-2 text-accent"></i>Thème & Couleur</h3>
                <div class="grid grid-cols-5 gap-3 mb-3">
                    <div class="color-dot bg-emerald-500" onclick="applyTheme('#10b981')"></div>
                    <div class="color-dot bg-blue-500" onclick="applyTheme('#3b82f6')"></div>
                    <div class="color-dot bg-red-500" onclick="applyTheme('#ef4444')"></div>
                    <div class="color-dot bg-purple-500" onclick="applyTheme('#a855f7')"></div>
                    <div class="color-dot bg-orange-500" onclick="applyTheme('#f97316')"></div>
                    <div class="color-dot bg-pink-500" onclick="applyTheme('#ec4899')"></div>
                    <div class="color-dot bg-cyan-400" onclick="applyTheme('#22d3ee')"></div>
                    <div class="color-dot bg-yellow-400" onclick="applyTheme('#facc15')"></div>
                    <div class="color-dot bg-white" onclick="applyTheme('#ffffff')"></div>
                    <div class="color-dot bg-slate-400" onclick="applyTheme('#94a3b8')"></div>
                </div>
                <div class="flex items-center gap-2"><span class="text-[9px] text-slate-500">Custom:</span><input type="color" id="custom-color-picker" onchange="applyTheme(this.value)" class="bg-transparent border-0 h-6 w-8 p-0 cursor-pointer"></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                 <h3 class="text-white text-xs uppercase font-bold mb-3"><i class="fa-solid fa-battery-full mr-2 text-accent"></i>Gestion Batterie</h3>
                 <div class="text-xs mb-3">
                     <label class="text-slate-500 block mb-1">Capacité MAX (km)</label>
                     <div class="flex gap-2"><input type="number" id="battery-max-range" onchange="saveBatterySettings()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white w-full" placeholder="Ex: 40"><span class="p-2 text-slate-500">km</span></div>
                 </div>
                 <button onclick="resetBatteryToFull()" class="w-full bg-accent text-slate-900 font-bold py-3 rounded-lg text-xs uppercase"><i class="fa-solid fa-bolt mr-2"></i> Recharge 100%</button>
            </div>

            <div class="glass-panel rounded-xl p-4 bg-slate-900/60 border border-slate-600 text-center flex-none">
                <span class="text-[10px] text-slate-400 uppercase font-bold mb-1">Odomètre Total</span>
                <div class="flex items-center justify-center gap-2 mt-2"><input type="number" id="odo-input" step="0.1" onchange="manualUpdateODO(this.value)" class="bg-transparent text-4xl font-mono font-black text-white w-40 text-center focus:outline-none border-b border-transparent focus:border-accent p-0 leading-none" placeholder="0.0"><span class="text-sm text-slate-500 font-bold">km</span></div>
                <p class="text-[8px] text-slate-500 mt-1 italic">Modifier manuellement déduit l'autonomie</p>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-slate-400 text-xs uppercase font-bold"><i class="fa-solid fa-chart-area mr-2"></i>Graphique</h3>
                    <div class="flex bg-slate-800 rounded p-0.5"><button onclick="setChartMode('dist')" id="btn-chart-dist" class="text-[9px] px-2 py-0.5 rounded text-slate-300 bg-slate-600">Km</button><button onclick="setChartMode('alt')" id="btn-chart-alt" class="text-[9px] px-2 py-0.5 rounded text-slate-500">Alt</button></div>
                </div>
                <div class="h-40 w-full relative"><canvas id="rideChart"></canvas></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 relative overflow-hidden flex-none">
                <h3 class="text-white font-bold mb-4 text-xs uppercase"><i class="fa-solid fa-wrench text-warning mr-2"></i>Entretien</h3>
                <div id="maintenance-container" class="space-y-4"></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-emerald-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-money-bill-wave mr-2"></i>Calculateur Économies</h3>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><label class="text-slate-500 block mb-1">Coût Voiture</label><input type="number" id="cost-car" step="0.01" onchange="saveEcoSettings()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white w-full" placeholder="0.20"></div>
                    <div><label class="text-slate-500 block mb-1">Coût Scooter</label><input type="number" id="cost-scooter" step="0.01" onchange="saveEcoSettings()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white w-full" placeholder="0.05"></div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-map-pin mr-2"></i>Adresses Rapides</h3>
                <div class="flex flex-col gap-2">
                    <input type="text" id="addr-home" onchange="saveAddresses()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white text-xs w-full" placeholder="Maison">
                    <input type="text" id="addr-work" onchange="saveAddresses()" class="bg-slate-900 border border-slate-700 rounded px-2 py-2 text-white text-xs w-full" placeholder="Travail">
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-lock mr-2"></i>Sécurité</h3>
                <div class="flex gap-2"><input type="number" id="new-pin-input" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm w-full outline-none" placeholder="Nouveau code"><button onclick="changeUserPin()" class="bg-slate-700 hover:bg-accent text-white px-4 py-2 rounded text-xs font-bold transition">OK</button></div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-slate-600 flex-none mb-6">
                <h3 class="text-slate-400 text-xs uppercase font-bold mb-3">Sauvegarde</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportJSON()" class="col-span-2 bg-slate-800 hover:bg-slate-700 text-slate-200 py-3 rounded text-xs border border-slate-600 font-bold"><i class="fa-solid fa-download mr-2"></i> Sauver (JSON)</button>
                    <button onclick="document.getElementById('fileInput').click()" class="col-span-2 bg-slate-800 hover:bg-slate-700 text-slate-200 py-3 rounded text-xs border border-slate-600"><i class="fa-solid fa-upload mr-2"></i> Restaurer</button>
                    <input type="file" id="fileInput" class="hidden" onchange="importJSON(this)">
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 glass-panel border-t border-slate-700/50 h-16 z-50">
        <div class="grid grid-cols-3 h-full max-w-7xl mx-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn active flex flex-col items-center justify-center text-slate-400 hover:text-white border-t-2 border-transparent transition-all"><i class="fa-solid fa-gauge-high text-lg mb-1"></i><span class="text-[10px] font-bold uppercase">Dash</span></button>
            <button onclick="switchTab('map')" id="nav-map" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-white border-t-2 border-transparent transition-all"><i class="fa-solid fa-location-arrow text-lg mb-1"></i><span class="text-[10px] font-bold uppercase">Cockpit</span></button>
            <button onclick="switchTab('garage')" id="nav-garage" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-white border-t-2 border-transparent transition-all"><i class="fa-solid fa-wrench text-lg mb-1"></i><span class="text-[10px] font-bold uppercase">Garage</span></button>
        </div>
    </nav>

    <script>
        // --- 1. CORE & PIN ---
        setInterval(() => { const el = document.getElementById('clock-display'); if(el) el.innerText = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}); }, 1000);
        let savedPin = localStorage.getItem('scooter_pin') || "0000"; let currentPin = "";
        function typePin(d) { if(currentPin.length<4){ currentPin+=d; updatePinDots(); if(currentPin.length===4) checkPin(); } }
        function clearPin() { currentPin=""; updatePinDots(); document.getElementById('login-error').classList.add('opacity-0'); }
        function updatePinDots() { for(let i=1;i<=4;i++) document.getElementById('dot-'+i).classList.toggle('filled', i<=currentPin.length); }
        function checkPin() { if(currentPin===savedPin) document.getElementById('login-overlay').style.display='none'; else { document.getElementById('login-error').classList.remove('opacity-0'); setTimeout(clearPin,500); } }
        function changeUserPin() { const n = document.getElementById('new-pin-input').value; if(n.length===4 && confirm('Changer PIN?')) { localStorage.setItem('scooter_pin', n); savedPin=n; alert('OK'); document.getElementById('new-pin-input').value=""; } }
        
        // --- 2. DATA & STATE ---
        let state = { 
            odo: 0, tripA: 0, tripB: 0, maintenance: null, logs: [], addresses: {home:'', work:''}, eco: {car: 0.20, scooter: 0.05}, 
            shortcutsMain: [null,null,null,null], shortcutsMini: [null,null,null,null],
            themeColor: '#10b981', batteryMax: 40, batteryCurrent: 40
        };
        
        function loadData() { 
            try { 
                const d = localStorage.getItem('trackMasterV24'); 
                if(d) {
                    const loaded = JSON.parse(d);
                    state = { ...state, ...loaded };
                    if(!state.maintenance || typeof state.maintenance !== 'object') {
                        state.maintenance = {
                            general: { last: loaded.maintenanceKm || 0, interval: loaded.maintInterval || 500 },
                            brakes: { last: state.odo, interval: 1500 },
                            tires: { last: state.odo, interval: 3000 }
                        };
                    }
                } 
                // INIT DEFAULT ARRAYS IF MISSING
                if(!state.shortcutsMain) state.shortcutsMain = [null,null,null,null];
                if(!state.shortcutsMini) state.shortcutsMini = [null,null,null,null];
                if(isNaN(state.tripA)) state.tripA = 0; if(isNaN(state.tripB)) state.tripB = 0;
                if(typeof state.batteryCurrent === 'undefined' || isNaN(state.batteryCurrent)) state.batteryCurrent = state.batteryMax;
                
                applyTheme(state.themeColor || '#10b981');
                updateUI(); 
            } catch(e){} 
        }
        function saveData() { localStorage.setItem('trackMasterV24', JSON.stringify(state)); }

        // --- THEME ENGINE ---
        function applyTheme(color) {
            document.documentElement.style.setProperty('--accent-color', color);
            state.themeColor = color;
            saveData();
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            if(polyline) polyline.setStyle({color: color});
        }

        // --- BATTERY ENGINE ---
        function saveBatterySettings() { state.batteryMax = parseFloat(document.getElementById('battery-max-range').value) || 40; saveData(); updateUI(); }
        function resetBatteryToFull() { if(confirm('Recharge complète confirmée ?')) { state.batteryCurrent = state.batteryMax; saveData(); updateUI(); } }

        // --- CALC ENGINE ---
        let calcExp = "";
        function openCalc() { document.getElementById('calc-overlay').style.display='flex'; calcExp=""; document.getElementById('calc-display').innerText="0"; }
        function closeCalc() { document.getElementById('calc-overlay').style.display='none'; }
        function calcAction(val) {
            if(val === 'C') calcExp = "";
            else if(val === 'back') calcExp = calcExp.slice(0,-1);
            else if(val === '=') { try { calcExp = eval(calcExp).toString(); } catch{ calcExp = "Error"; } }
            else calcExp += val;
            document.getElementById('calc-display').innerText = calcExp || "0";
        }

        // --- APP LAUNCHER ENGINE (FIXED) ---
        function launchApp(url) {
            if(!url) return;
            // Catch special actions (new)
            if(url === 'action_camera' || url.includes('camera')) { document.getElementById('camera-trigger').click(); return; }
            if(url === 'action_calc' || url.includes('calc')) { openCalc(); return; }
            
            // Standard links
            if(url.startsWith('http')) { window.open(url, '_blank'); } else { window.location.href = url; }
        }

        // --- METEO & NAV ---
        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation_probability&forecast_days=1`);
                const data = await res.json();
                const temp = Math.round(data.current.temperature_2m);
                let icon = '<i class="fa-solid fa-cloud text-slate-300"></i>';
                if(data.current.precipitation_probability > 50) icon = '<i class="fa-solid fa-cloud-showers-heavy text-blue-400"></i>';
                else if(temp > 20) icon = '<i class="fa-solid fa-sun text-yellow-400"></i>';
                document.getElementById('top-weather').innerHTML = `${icon} <span class="text-white">${temp}°</span>`;
            } catch(e) {}
        }

        function saveEcoSettings() {
            state.eco.car = parseFloat(document.getElementById('cost-car').value) || 0.20;
            state.eco.scooter = parseFloat(document.getElementById('cost-scooter').value) || 0.05;
            saveData(); updateUI();
        }

        function saveAddresses() {
            state.addresses.home = document.getElementById('addr-home').value;
            state.addresses.work = document.getElementById('addr-work').value;
            saveData();
        }

        function openNav(type) {
            const addr = state.addresses[type];
            if(!addr) return alert("Veuillez configurer l'adresse dans le Garage.");
            if(confirm("Ouvrir Waze ?")) window.open(`https://waze.com/ul?q=${encodeURIComponent(addr)}&navigate=yes`, '_blank');
        }

        // --- GPS CORE ---
        let map, polyline, marker, watchId, isTimerRunning=false, timerInterval, timerSeconds=0, currentTripDist=0, trackPoints=[], currentMaxSpeed=0;
        let mapTileLayer, isDarkMap = true, historyPolyline = null;
        let wakeLock=null; async function requestWakeLock(){ if('wakeLock' in navigator) try{ wakeLock=await navigator.wakeLock.request('screen'); document.getElementById('wake-icon').classList.add('wake-active'); }catch(e){} }
        
        window.onload = function() { loadData(); document.getElementById('input-date').valueAsDate = new Date(); initMap(); requestWakeLock(); };

        function initMap() { 
            map = L.map('map', {zoomControl:false}).setView([48.85, 2.35], 16);
            mapTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {maxZoom: 20}).addTo(map);
            const arrowIcon = L.divIcon({ className:'custom-div-icon', html:"<div class='nav-arrow-container'><div id='gps-arrow' class='nav-arrow'></div></div>", iconSize:[40,40], iconAnchor:[20,20] });
            marker = L.marker([0,0], {icon: arrowIcon}).addTo(map);
            polyline = L.polyline([], {color: state.themeColor, weight:5}).addTo(map);
            historyPolyline = L.polyline([], {color:'#06b6d4', weight:5, dashArray: '10, 10'}).addTo(map);
        }

        function toggleMapTheme() {
            isDarkMap = !isDarkMap;
            mapTileLayer.setUrl(isDarkMap ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
            document.getElementById('map-theme-icon').className = isDarkMap ? "fa-solid fa-sun text-yellow-400" : "fa-solid fa-moon text-slate-300";
        }

        function centerMap() { if(!navigator.geolocation) return alert("Pas de GPS"); navigator.geolocation.getCurrentPosition(p=>{map.setView([p.coords.latitude, p.coords.longitude], 18);}); }

        function toggleGPSMode() {
            if(document.getElementById('gps-toggle').checked) {
                if(!navigator.geolocation) return alert("GPS HS");
                requestWakeLock();
                navigator.geolocation.getCurrentPosition(p => fetchWeather(p.coords.latitude, p.coords.longitude));
                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    const spd = pos.coords.speed ? Math.round(pos.coords.speed*3.6) : 0;
                    const alt = pos.coords.altitude ? Math.round(pos.coords.altitude) : 0;
                    document.getElementById('gps-status').innerText = "ON"; document.getElementById('gps-status').className = "text-emerald-400 font-bold text-[8px]";
                    document.getElementById('dash-speed').innerText = spd; document.getElementById('hud-speed').innerText = spd;
                    document.getElementById('hud-alt').innerText = alt;
                    marker.setLatLng([lat,lon]);
                    const arrow = document.getElementById('gps-arrow'); if(arrow) arrow.style.transform = `rotate(${pos.coords.heading||0}deg)`;
                    map.setView([lat,lon]);

                    if(isTimerRunning) {
                        if(spd > currentMaxSpeed) currentMaxSpeed = spd;
                        if(pos.coords.accuracy > 40) return;
                        trackPoints.push({lat, lon, ele: alt, time: new Date()});
                        polyline.addLatLng([lat,lon]);
                        if(trackPoints.length > 1) {
                            const last = trackPoints[trackPoints.length-2];
                            const d = 6371 * 2 * Math.atan2(Math.sqrt(Math.sin((lat-last.lat)*Math.PI/360)**2 + Math.cos(last.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lon-last.lon)*Math.PI/360)**2), Math.sqrt(1-Math.sin((lat-last.lat)*Math.PI/360)**2 - Math.cos(last.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lon-last.lon)*Math.PI/360)**2));
                            if(d > 0.002) { 
                                currentTripDist += d; 
                                state.batteryCurrent -= d;
                                if(state.batteryCurrent < 0) state.batteryCurrent = 0;
                                saveData();
                                updateUI();
                                document.getElementById('dash-dist').innerText = currentTripDist.toFixed(2); 
                                document.getElementById('hud-dist').innerText = currentTripDist.toFixed(1); 
                                document.getElementById('input-dist').value = currentTripDist.toFixed(2); 
                            }
                        }
                        document.getElementById('btn-gpx').disabled = false; document.getElementById('btn-gpx').classList.remove('text-slate-400'); document.getElementById('btn-gpx').classList.add('text-white', 'border-accent');
                    }
                }, err => {}, {enableHighAccuracy:true});
            } else { navigator.geolocation.clearWatch(watchId); document.getElementById('gps-status').innerText = "OFF"; }
        }

        function toggleTimer() {
            const btn = document.getElementById('btn-timer'); const rec = document.getElementById('rec-dot');
            if(!isTimerRunning) {
                isTimerRunning=true; timerSeconds=0; currentTripDist=0; currentMaxSpeed=0; trackPoints=[]; 
                polyline.setLatLngs([]); if(historyPolyline) historyPolyline.setLatLngs([]);
                btn.classList.replace('bg-accent','bg-red-500'); btn.classList.replace('text-slate-900','text-white');
                rec.classList.replace('bg-slate-600', 'bg-red-500'); rec.classList.add('animate-pulse');
                if(!document.getElementById('gps-toggle').checked) { document.getElementById('gps-toggle').checked=true; toggleGPSMode(); }
                timerInterval = setInterval(()=>{ timerSeconds++; const h=Math.floor(timerSeconds/3600), m=Math.floor((timerSeconds%3600)/60), s=timerSeconds%60; const txt=`${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`; document.getElementById('timer-display').innerText=txt; document.getElementById('hud-timer').innerText=txt; }, 1000);
            } else { 
                isTimerRunning=false; clearInterval(timerInterval); 
                btn.classList.replace('bg-red-500','bg-accent'); btn.classList.replace('text-white','text-slate-900'); 
                rec.classList.replace('bg-red-500', 'bg-slate-600'); rec.classList.remove('animate-pulse'); 
            }
        }
        
        // --- ADD LOG : HERE IS THE FIX FOR BATTERY DECREASE ---
        function addLog() { 
            if(isTimerRunning) toggleTimer(); 
            const dist = parseFloat(document.getElementById('input-dist').value); if(!dist || dist<=0) return alert("0 km ?"); 
            state.odo += dist; state.tripA += dist; state.tripB += dist;
            
            // FIX: DECREASE BATTERY ON SAVE
            state.batteryCurrent = (state.batteryCurrent || 40) - dist;
            if(state.batteryCurrent < 0) state.batteryCurrent = 0;

            state.logs.unshift({id: Date.now(), title: document.getElementById('input-title').value||"Trajet", date: document.getElementById('input-date').value, dist: dist.toFixed(1), max: currentMaxSpeed, track: [...trackPoints]}); 
            saveData(); updateUI(); 
            document.getElementById('input-dist').value = ""; document.getElementById('timer-display').innerText="00:00:00"; document.getElementById('hud-dist').innerText="0.0";
            document.getElementById('btn-gpx').disabled = true; document.getElementById('btn-gpx').classList.add('text-slate-400');
        }

        function viewOnMap(id) {
            const log = state.logs.find(l => l.id === id);
            if(!log || !log.track || log.track.length === 0) return alert("Pas de GPS");
            switchTab('map');
            const latlngs = log.track.map(p => [p.lat, p.lon]);
            if(historyPolyline) historyPolyline.setLatLngs(latlngs);
            map.fitBounds(historyPolyline.getBounds());
        }

        function downloadLogGPX(id) {
            const log = state.logs.find(l => l.id === id);
            if(!log || !log.track || log.track.length === 0) return alert("Pas de GPS");
            let gpx = `<?xml version="1.0"?><gpx version="1.1"><trk><name>${log.title}</name><trkseg>`;
            log.track.forEach(p => { gpx += `<trkpt lat="${p.lat}" lon="${p.lon}"><ele>${p.ele}</ele><time>${new Date(p.time).toISOString()}</time></trkpt>`; });
            gpx += `</trkseg></trk></gpx>`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([gpx],{type:'application/gpx+xml'}));
            a.download = `Trajet_${log.date}.gpx`; a.click();
        }

        function resetTrip(type) { if(confirm('Reset Trip '+type+'?')) { state['trip'+type] = 0; saveData(); updateUI(); } }
        function resetMultiMaint(key) { if(confirm('Reset '+key+'?')) { state.maintenance[key].last = state.odo; saveData(); updateUI(); } }
        function setMaintInterval(key) { const v=prompt("Intervalle:"); if(v&&!isNaN(v)){ state.maintenance[key].interval=parseFloat(v); saveData(); updateUI(); } }

        // --- CHART (DIST / ALT) ---
        let chartInstance = null; let chartMode = 'dist'; 
        function setChartMode(m) { chartMode = m; document.getElementById('btn-chart-dist').className = m==='dist' ? "text-[9px] px-2 py-0.5 rounded text-slate-300 bg-slate-600" : "text-[9px] px-2 py-0.5 rounded text-slate-500"; document.getElementById('btn-chart-alt').className = m==='alt' ? "text-[9px] px-2 py-0.5 rounded text-slate-300 bg-slate-600" : "text-[9px] px-2 py-0.5 rounded text-slate-500"; renderChart(); }
        function renderChart() {
            const ctx = document.getElementById('rideChart'); if(!ctx) return;
            if(chartInstance) chartInstance.destroy();
            let labels=[], data=[], color = state.themeColor;
            if(chartMode === 'dist') {
                const logs = state.logs.slice(0, 7).reverse();
                labels = logs.map(l => l.date.substring(5)); data = logs.map(l => parseFloat(l.dist));
            } else {
                if(state.logs.length > 0 && state.logs[0].track) {
                    const track = state.logs[0].track;
                    for(let i=0; i<track.length; i+=Math.max(1, Math.floor(track.length/50))) { labels.push(""); data.push(track[i].ele); }
                    color = '#3b82f6';
                } else { labels = ["No Data"]; data = [0]; }
            }
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: chartMode, data: data, borderColor: color, backgroundColor: color+'33', borderWidth: 2, tension: 0.4, fill: true, pointRadius: chartMode==='alt'?0:3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8', font: {size:8} } }, x: { display: true, grid: { display: false }, ticks: { color: '#94a3b8', font: {size:8} } } } } });
        }

        // --- SHORTCUTS ENGINE (FIXED) ---
        let editTarget = null; let currentSlotIndex = -1;
        function renderShortcuts(type) { 
            const grid = document.getElementById(`shortcut-grid-${type}`); if(!grid) return; grid.innerHTML = '';
            const list = type === 'main' ? state.shortcutsMain : state.shortcutsMini;
            const isEditing = (editTarget === type);
            const heightClass = 'h-14'; 

            list.forEach((app, index) => {
                const btn = document.createElement('div');
                if (app) {
                    // FORCE INTERCEPTION
                    let action = `launchApp('${app.url}')`;
                    if(isEditing) action = `openAppModal('${type}', ${index})`;

                    btn.className = `relative ${heightClass} rounded-xl flex flex-col items-center justify-center gap-0.5 transition active:scale-95 cursor-pointer overflow-hidden border ${isEditing ? 'border-yellow-500 bg-yellow-500/10 animate-pulse' : 'border-slate-700 bg-slate-800/50 hover:bg-slate-700'}`;
                    btn.setAttribute('onclick', action);
                    btn.style.borderColor = isEditing ? '#eab308' : (app.color + '40');
                    btn.innerHTML = `<i class="${app.icon} text-lg mb-0.5" style="color: ${app.color}"></i><span class="text-[8px] font-bold text-slate-300 truncate w-full text-center px-1">${app.name}</span>${isEditing ? '<div class="absolute top-0 right-0 text-[7px] text-yellow-500 p-0.5"><i class="fa-solid fa-pencil"></i></div>' : ''}`;
                } else {
                    btn.className = `${heightClass} rounded-xl border border-dashed border-slate-700 flex items-center justify-center text-slate-600 hover:text-accent hover:border-accent transition cursor-pointer active:scale-95 bg-slate-900/30`;
                    btn.onclick = () => openAppModal(type, index);
                    btn.innerHTML = `<i class="fa-solid fa-plus text-sm"></i>`;
                }
                grid.appendChild(btn);
            });
        }

        function toggleEditMode(type) { if(editTarget && editTarget !== type) toggleEditMode(editTarget); editTarget = (editTarget === type) ? null : type; renderShortcuts(type); }
        function openAppModal(type, index) {
            currentSlotIndex = index; window.modalTargetType = type; const modal = document.getElementById('app-modal');
            const list = type === 'main' ? state.shortcutsMain : state.shortcutsMini; const existing = list[index]; document.getElementById('app-select').value = 'custom';
            if (existing) { document.getElementById('app-name').value = existing.name; document.getElementById('app-url').value = existing.url; document.getElementById('app-icon').value = existing.icon; document.getElementById('app-color').value = existing.color; document.getElementById('btn-delete-app').classList.remove('hidden'); } 
            else { document.getElementById('app-name').value = ""; document.getElementById('app-url').value = ""; document.getElementById('app-icon').value = "fa-solid fa-cube"; document.getElementById('app-color').value = "#ffffff"; document.getElementById('btn-delete-app').classList.add('hidden'); }
            modal.classList.add('flex'); modal.classList.remove('hidden');
        }
        function closeAppModal() { document.getElementById('app-modal').classList.add('hidden'); document.getElementById('app-modal').classList.remove('flex'); }
        function prefillApp() { const val = document.getElementById('app-select').value; if (val === 'custom') return; const [name, url, icon, color] = val.split('|'); document.getElementById('app-name').value = name; document.getElementById('app-url').value = url; document.getElementById('app-icon').value = icon; document.getElementById('app-color').value = color; }
        function saveShortcut() {
            const name = document.getElementById('app-name').value; const url = document.getElementById('app-url').value;
            const icon = document.getElementById('app-icon').value; const color = document.getElementById('app-color').value;
            if (!name || !url) return alert("Nom et lien requis");
            const type = window.modalTargetType;
            if(type === 'main') state.shortcutsMain[currentSlotIndex] = { name, url, icon, color }; else state.shortcutsMini[currentSlotIndex] = { name, url, icon, color };
            saveData(); renderShortcuts(type); closeAppModal(); if(editTarget === type) toggleEditMode(type); 
        }
        function deleteCurrentShortcut() { if(confirm('Supprimer ?')) { const type = window.modalTargetType; if(type === 'main') state.shortcutsMain[currentSlotIndex] = null; else state.shortcutsMini[currentSlotIndex] = null; saveData(); renderShortcuts(type); closeAppModal(); } }

        // --- MANUAL ODO UPDATE WITH BATTERY LOGIC (FIXED) ---
        function manualUpdateODO(v) {
            const newVal = parseFloat(v);
            const oldVal = state.odo;
            if(isNaN(newVal)) return;
            const diff = newVal - oldVal;
            if(diff > 0) {
                state.batteryCurrent = (state.batteryCurrent || 40) - diff;
                if(state.batteryCurrent < 0) state.batteryCurrent = 0;
            }
            state.odo = newVal;
            saveData();
            updateUI();
        }

        function exportCurrentGPX() { if(trackPoints.length<2) return alert("Pas de trajet"); let gpx=`<?xml version="1.0"?><gpx version="1.1"><trk><trkseg>`; trackPoints.forEach(p=>{gpx+=`<trkpt lat="${p.lat}" lon="${p.lon}"><ele>${p.ele}</ele><time>${p.time.toISOString()}</time></trkpt>`;}); gpx+=`</trkseg></trk></gpx>`; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([gpx],{type:'application/gpx+xml'})); a.download=`Trajet.gpx`; a.click(); }
        function exportJSON() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state)); a.download="backup.json"; a.click(); }
        function importJSON(i) { const r=new FileReader(); r.onload=e=>{ state={...state, ...JSON.parse(e.target.result)}; saveData(); updateUI(); alert("OK"); }; r.readAsText(i.files[0]); }
        function deleteLog(id) { if(confirm('Supprimer ?')) { const i=state.logs.findIndex(l=>l.id===id); if(i>-1) { state.odo-=parseFloat(state.logs[i].dist); state.logs.splice(i,1); saveData(); updateUI(); } } }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+id).classList.add('active'); if(id==='map') setTimeout(()=>{ if(map) { map.invalidateSize(); centerMap(); } },200); if(id==='garage') renderChart(); } 

        function updateUI() { 
            if(document.getElementById('odo-input')) document.getElementById('odo-input').value = state.odo.toFixed(1);
            document.getElementById('disp-odo-total').innerText = state.odo.toFixed(1);
            document.getElementById('disp-trip-a').innerText = (state.tripA || 0).toFixed(1);
            document.getElementById('disp-trip-b').innerText = (state.tripB || 0).toFixed(1);
            document.getElementById('battery-max-range').value = state.batteryMax || 40;
            
            document.getElementById('batt-range-dash').innerText = (state.batteryCurrent || 0).toFixed(1);
            document.getElementById('hud-range').innerText = (state.batteryCurrent || 0).toFixed(1);

            const cont = document.getElementById('maintenance-container');
            if(cont && state.maintenance) {
                cont.innerHTML = '';
                const keys = { general: 'Général', brakes: 'Freins', tires: 'Pneus' };
                const icons = { general: 'fa-wrench', brakes: 'fa-circle-stop', tires: 'fa-road' };
                for (const [key, label] of Object.entries(keys)) {
                    const item = state.maintenance[key];
                    const diff = state.odo - item.last;
                    const pct = Math.min(100, (diff / item.interval) * 100);
                    const isAlert = diff >= item.interval;
                    cont.innerHTML += `<div class="mb-2"><div class="flex justify-between text-xs text-slate-300 mb-1"><span><i class="fa-solid ${icons[key]} text-[10px] mr-1 text-slate-500"></i>${label}</span><span class="cursor-pointer hover:text-white" onclick="setMaintInterval('${key}')">${diff.toFixed(0)} / ${item.interval}</span></div><div class="flex items-center gap-2"><div class="flex-grow overflow-hidden h-2 rounded-full bg-slate-700"><div style="width: ${pct}%" class="h-full transition-all duration-500 ${isAlert ? 'bg-red-500 animate-pulse' : 'bg-accent'}"></div></div><button onclick="resetMultiMaint('${key}')" class="text-[9px] bg-slate-700 px-2 py-0.5 rounded text-white hover:bg-accent hover:text-black font-bold">FAIT</button></div></div>`;
                }
            }
            
            document.getElementById('savings-display').innerText = ((state.eco.car - state.eco.scooter) * state.odo).toFixed(0);
            document.getElementById('cost-car').value = state.eco.car; document.getElementById('cost-scooter').value = state.eco.scooter;
            document.getElementById('addr-home').value = state.addresses.home || ""; document.getElementById('addr-work').value = state.addresses.work || "";

            const tb = document.getElementById('logs-table-body'); 
            if(tb) { 
                tb.innerHTML=''; 
                if(state.logs.length===0) document.getElementById('empty-state').classList.remove('hidden'); 
                else { 
                    document.getElementById('empty-state').classList.add('hidden'); 
                    state.logs.forEach(l => { 
                        const hasTrack = l.track && l.track.length > 0;
                        const opacityClass = hasTrack ? 'opacity-100 hover:text-white' : 'opacity-30 cursor-not-allowed';
                        const tr = document.createElement('tr'); 
                        tr.innerHTML = `<td class="py-2 px-1"><div class="font-bold text-slate-200">${l.title}</div><div class="text-[9px] text-slate-500">${l.date}</div></td><td class="py-2 px-1 text-right"><div class="text-accent font-bold">+${l.dist}</div><div class="text-[9px] text-slate-500">Max ${l.max||0} km/h</div></td><td class="py-2 px-1 text-right flex justify-end gap-2 items-center h-full pt-3"><button onclick="viewOnMap(${l.id})" class="text-cyan-400 ${opacityClass}"><i class="fa-solid fa-eye"></i></button><button onclick="downloadLogGPX(${l.id})" class="text-emerald-400 ${opacityClass}"><i class="fa-solid fa-floppy-disk"></i></button><button onclick="deleteLog(${l.id})" class="text-slate-600 hover:text-red-500 ml-1"><i class="fa-solid fa-trash"></i></button></td>`; 
                        tb.appendChild(tr); 
                    }); 
                } 
            }
            renderShortcuts('main');
            renderShortcuts('mini');
            if(document.getElementById('tab-garage').classList.contains('active')) renderChart();
            document.getElementById('battery-max-range').value = state.batteryMax || 40;
        }
    </script>
</body>
</html>